---
title: 走弯路也是前进的一种方式
date: 2022-09-25 15:32:27
cover: https://s2.loli.net/2022/09/25/dFcS8GsiDrKJowj.jpg
thumbnail: https://s2.loli.net/2022/09/25/dFcS8GsiDrKJowj.jpg
categories:
- [随笔]
- [观点]
tags:
- javascript
---
### 写在前面的话
这并不是一道选择题，有时候只有一条路甚至迷雾重重找不到方向，在临近终点时才终于发现了捷径，之后我们把这个归结为经验。

### 缘起
最近在玩一款手机上的页游，翻看了一下游戏中赛季的记录居然已经有三年了。还清晰地记得上一次退坑狂野飙车8的时候，现在想起来狂野飙车仍旧是一款可玩性非常高的游戏，然而无休止的活动带来的每天早中晚工作一样的“打卡”操作终于让我深感疲惫。在那个氪金趋势愈发明显的时代里，有这样一款靠肝和技术还能对抗氪佬与欧鳇的游戏是相当难得的，然而每日定时的肝真的会耗尽玩家的热情与精力。熟悉那款游戏或者其他竞技类游戏的玩家应该有同感，为了出成绩就要高度集中注意力，进而带来的就是精力的快速消耗，放下手机、推开键盘、从座位上站起时的那种疲惫感是不是相当熟悉呢。于是，我为了充分的休息换了一款收菜游戏，三年后它变了。

<!--more-->

改变是慢慢出现的，游戏最初的玩法几乎相当于没有，每天就是点几下收工，和旅行青蛙也没有多大差别。或许是为了玩家、或许是为了盈利，游戏中的玩法逐渐丰富了起来。游戏策划并不喜欢修复不利于玩家的bug或者优化游戏体验，而仅仅热衷于开发新玩法。从游戏中的数据推算，氪金点的丰富也的确大大提升了玩家的支出。当然，伴随而来的收菜复杂度也逐渐上升，加之游戏本身时不时就会卡死，三年前那种疲惫的感觉再次袭来，似乎又到了弃游的时候。

然而就在此时，普罗米修斯盗来一段代码从天而降，从此有了火，开启了新的时代。

### 石器时代
![石器时代.jpg](https://s2.loli.net/2022/09/25/5yPef3M4cLuDWGa.jpg)
>石器时代，是考古学家假定的一个时间区段，为考古学上的术语。分为旧石器时代、中石器时代与新石器时代。是考古学对早期人类历史分期的第一个时代，即从出现人类到青铜器的出现，大约始于距今二三百万年，止于距今5000至2000年左右。

一段代码的出现，让玩家迎来了石器时代。
```javascript
int1 = setInterval(
    () => {
        if (document.querySelector('.cardwar-pve-boss-challenge')) {
            angular.element(document.querySelector('.cardwar-pve-boss-challenge')).triggerHandler('click');
        };
        if (document.querySelectorAll('.btn span')[2]) {
            angular.element(document.querySelectorAll('.btn span')[2]).triggerHandler('click');
        };
    }, 1000)
```
一切都是从这段代码开始的，它让我知道了两件事：第一，游戏使用angularjs框架；第二，可以通过代码触发页面内的点击操作。于是`angular.element().triggerHandler()`成为了最早的工具，古朴而直接。着这里感到非常惭愧，作为一名自诩为计算机爱好者居然没有主动去F12一下，事实证明就是单纯的水平低，哈哈。

顺着这条路的方向，我开始研究游戏内各种页面跳转的逻辑，衍生出了一些新的工具：页面状态检测、间隔函数立即执行、根据状态终止间隔函数等等。
```javascript
var delayInterval = function (interval, state, callback, sleep) {
    var _int = -1;
    intStart = () => {
        _int = setInterval(() => {
            if (state()) {
                clearInterval(_int);
                callback();
                setTimeout(() => {
                    intStart()
                }, sleep);
            }
        }, interval);
    }
    intStart();
}
```
游戏内的机制并不能随时随刻的进行测试，只能在可操作的那段时间反复验证代码的健壮性。总体来说改进后工具的执行效果还是令人满意的，然而游戏自身问题导致的一些错误总是很随机的出现。如同智子对实验结果的影响，知道问题会出现却又无法避免，直到另一段代码的出现。

### 青铜时代
![青铜时代.jpg](https://s2.loli.net/2022/09/25/ZmzAHvwM8XdOYlC.jpg)
>青铜时代具备这样一个特点：青铜器在人们的生产、生活中占据重要地位，偶然地制造和使用青铜器的时代不能认定为青铜时代。

```javascript
var xmlHttp = new XMLHttpRequest();
var date = new Date();
xmlHttp.open('GET',
    `https://` + servURL + `/PlayerFight/killBoss?post_time=${date.getTime()}&
    TEAM_USER_TOKEN=${token}&os=m`, false)
```
并不是要马后炮，httpRequest的方式我曾经考虑过，因为有过模拟登录和抓包的经验，实现起来并不困难。然而当时一直沉溺在`triggerHandler`的新鲜感中，那种定时开启、自动跳转的视觉效果比后台默默执行更具穿透力，但是这种方式有一个明显的问题————效率不够且独占前台。

在此之后，新工具雨后春笋般得出现。游戏中各种收菜操作得到了空前的简化，以往二三十分钟的工作点几下脚本轻松搞定（这里推荐一下ios上的Alook浏览器，6元的价格物有所值）。这时我的感觉就如同“物理大厦已经落成，所剩只是一些修饰工作”，每完成一个脚本就进入寻找下一个简化操作的流程。然后我就遇到了问题，“它的美丽而晴朗的天空却被两朵乌云笼罩了”，甚至不止两朵。

在使用新工具披荆斩棘的路上，惊奇的发现游戏中有一些操作是不产生request/response包的。游戏代码并不能离线执行，如果不是通过req的形式，那就一定有其他方式传递数据。翻遍了Chrome Devtools的每一个角落，依然没有线索，只好把问题暂行搁置。

天降神秘代码推动发展的时期已然成为过去，后面的路要靠自己一步步走出来了。如同每一个偶然的事件激发了人类进步一样，我找到了那个开启下一个时代的钥匙。

### 铁器时代
![铁器时代.jpg](https://s2.loli.net/2022/10/03/67FvuhbPHpsl4a1.jpg)
>当人们在冶炼青铜的基础上逐渐掌握了冶炼铁的技术之后，铁器时代就到来了。

在即时通讯网学习过一些关于Websocket的知识，却从来没有接触过实际应用的例子，以致就缺乏足够的敏感。在我找寻那些不使用request方式进行通信的线索时，已经几乎找到答案了，但依旧视而不见，可谓不识朱砂只当是红土啊。

![websocket.jpg](https://s2.loli.net/2022/10/03/HoqgMLsDvmzdBiC.jpg)

在这个WS的标签页，第一感觉是为什么只有一个请求包，即便在点击了消息页之后也没有仔细查看，转而去看其他页面了。

我时常使用FM游戏中的一项球员属性来形容自己————预判19（最高为20），在此刻看来真是无知而傲慢啊。如果不能用已有的知识举一反三，如果不能敏锐的发现眼前的蛛丝马迹，如果不能独自解决问题，何来自夸的高预判啊。在这次走弯路的几个重要节点上，上面这三个痛处几乎全部命中。

>弱小和无知，都不是生存的障碍，傲慢才是。 ————《三体》

总算终于还是发现了这把钥匙，游戏中那些不寻常通信模式的的数据在这里一览无余。初始化、心跳连接、游戏数据，一切都显得顺理成章，星光坦途尽在眼前。

随即模拟登录的经验继续操练起来，建立连接、模拟发包、接收数据处理都不在话下，然而还是遇到了一个棘手的问题————游戏中在已有websoket链接的情况下不允许建立通信。像爬了81层楼发现没带钥匙一样的沮丧，既往的努力变得毫无意义。

尝试各种方法试图强制现有链接掉线或者直接关闭连接，习惯性的搜索、满怀希望的尝试、失败继而失望、继续搜索往复循环，在我以往的编码经历中有过无数次这样的循环，身心俱疲、后背微酸的感觉也再次袭来。乌云遮住了晴朗的天空，不知道何时放晴。

>拨云见日终有时，守得云开见月明

云天明精心编制的童话故事给了人类线索和希望，怎样解读就要靠人们自己了。

石器时代朴素古拙的武器重现，敲开了通往新世界的大门。

### 蒸汽时代
![蒸汽时代.jpg](https://s2.loli.net/2022/10/03/tBkKmXJQOErnlG2.jpg)
>在这个时期，资本主义的机器大革命开始出现，资本主义的世界体系开始初步确立。一种新的动力机器：蒸汽机的发明和应用，将人类带入了蒸汽时代。

也许除了`triggerHandler`，angular的另一件武器`scope`才算是它的杀手锏。

在开始探索各种触发函数的时期，我也注意到了通过scope可以直接调用一些游戏原生的方法，而且比之触发点击来的更为精确。同时我发现总有一些输出日志的函数在scope范围内不存在，由于对angular的不甚了解，于是便寄希望于rootscope，因此进入了一个不断找寻引用rootscope办法的误区。

或许找到了依然视而不见，我并不想去深入研究angularjs的原理，毕竟这算是一个半退役状态的框架，不值得在上面耗费时间。代价就是钝刀砍柴，磨刀的时间也没能省下来。

终于在无数次大力过后奇迹出现，操作原有websocket连接和angular的scope相交在了一起，**scope中的websocket示例居然可以直接调用**。

各种实例方法和事件监听函数唾手可得，不再等待，clsoe掉原有的，然后用自建的函数重新连接，静待着定制的粗体蓝色的log文字出现。然而期盼依旧的onmessage函数却没有如期运转，在几分钟过后，粗体蓝色的文字“连接已关闭”打印在了屏幕上。

这一次高预判及时出现，既然已经获得了websocket示例，又何必去关闭它，直接用不就得了。

```javascript
var a1=$scope.socket.onmessage;//省大事了
$scope.socket.onmessage=function(e){console.log('接管了');a1(e);}
```
在看到“接管了”成功输出之后，我知道又一个新的时代开启了。奠基性研究成功后，各种应用性研究便会如约而至，我毫不怀疑这一点。

### 写在后面的话
写下这段文字时，距离上面“接管了”那段代码已经过去两周了，为了记录下前面走过的种种弯路，我决定在完成这篇文字前不继续后面的探索。后面的路线和问题都是未知的，确定的是那会是一个充满希望的方向。

走弯路也是前进的一种方式，所有的经历终将汇聚成宝贵的经验。